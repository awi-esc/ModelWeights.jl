# Loading data

Data is loaded with the function `defineDataMap`. `DataMap` is just a type alias for a 
Dictionary mapping from Strings to [YAXArrays](https://juliadatacubes.github.io/YAXArrays.jl/v0.6.1/).

The function `defineDataMap` defines several methods which we explain further below. 
They usually provide (among others) the keyword arguments `dtype` and `filename_format`. 

The latter is needed as the information that is needed to load the specified data is retrieve 
from the filenames. 
There are three predefined filename formats:

-  ``VARIABLE_TABLEID_MODEL_EXPERIMENT_VARIANT_GRID_TIMERANGE`` (:cmip) is the default
- ``MIP_MODEL_TABLEID_EXPERIMENT_VARIANT_VARIABLE`` (:esmvaltool_cmip5)
-  ``MIP_MODEL_TABLEID_EXPERIMENT_VARIANT_VARIABLE_GRID`` (:esmvaltool_cmip6)

It is also possible to use the format ``:esmvaltool`` which will specify for every file 
whether it corresponds to CMIP5 or CMIP6. 

[Further, it is possible to specify your own filename format.]: #

The keyword argument `dtype` is just used to provide specific meta data when `dtype="cmip"`.
This should be specified when working with CMIP data, since by default the data type is set to undefined.

The following examples are all for CMIP data.

## Loading data from directories

The datasets loaded in a DataMap all refer to a single variable and experiment, i.e. the 
YAXArrays have the dimensions of the grid the data is defined on, e.g., (`lon`, `lat`) or, 
for 3D data, (`lon`, `lat`, `depth`).

To load data for different datasets, e.g. variable tos for lgm and historical experiment:

````julia
paths_datasets = ["path/to/lgm/tos", "path/to/historical/tos"]
ids_datasets = ["lgm-tos", "historical-tos"]
defineDataMap(paths_datasets, ids_datasets; dtype = "cmip")
````

You might have several directories from where you want to load data for a single dataset, e.g. 
when you store CMIP5 and CMIP6 data at different locations. `defineDataMap` also accepts Vectors 
of Vectors, e.g.:

````julia
paths_datasets = [
    ["path/to/cmip5/lgm/tos", "path/to/cmip6/lgm/tos"], 
    ["path/to/cmip5/historical/tos", "path/to/cmip6/historical/tos"]
]
ids_datasets = ["lgm-tos", "historical-tos"]
defineDataMap(paths_datasets, ids_datasets; dtype = "cmip")
````

If you just want to load a single dataset, Vectors aren't needed, e.g.:

````julia
defineDataMap("path/to/lgm/tos", "lgm-tos"; dtype = "cmip")
````

## Loading data preprocessed with ESMValTool 

### Based on recipes
If you use ESMValTool to preprocess data, you can use the recipes for preprocessing the data 
as config files to load the or some of the data into a ModelWeights.DataMap.
The first argument points to the top-level directory where the data is stored, namely the same
that was used in ESMValTool as base data directory.
The second argument points to a directory that contains one or more recipes, namely the filled out versions of the recipes that are generated by ESMValTool, to be found in the run-directory. These have the same name as the recipe itself concatenated with _filled in the end.

[Note that not everything in the recipes is actually needed for loading the data. For a minimal example with the unnecessary sections removed, see TODO]: #

To ensure that the first two arguments are correctly interpreted, the third argument must be set
to `:esmvaltool_recipes`.  
In this case, the default value for `filename_format` is set to :esmvaltool, not :cmip. 

````julia
defineDataMap("path/to/base/data/dir", "path/to/recipes/dir", :esmvaltool_recipes; dtype = "cmip")
````

### Based on config files

If the data was preprocessed with ESMValTool, it is also possible to specify a config yaml file with 
the required values. Here is an example: 

````yaml
TODO
````


